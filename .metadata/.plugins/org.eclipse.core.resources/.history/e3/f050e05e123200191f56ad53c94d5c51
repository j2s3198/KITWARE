<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>

	<link rel="stylesheet" type="text/css" href="${pageContext.request.contextPath}/resources/jquery-easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="${pageContext.request.contextPath}/resources/jquery-easyui/themes/icon.css">
    <!-- <link rel="stylesheet" type="text/css" href="/resources/jquery-easyui/demo.css"> -->
    <script type="text/javascript" src="${pageContext.request.contextPath}/resources/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="${pageContext.request.contextPath}/resources/jquery-easyui/jquery.easyui.min.js"></script>

	<div class=" container">
	
	<div class="row" style="margin: 20px; overflow-x:hidden; overflow-y:auto;">
	<h2>결재자 찾기</h2>
	</div>
	<div class="row">
	<div class="container col-5" style="padding: 3px">
    <div class="easyui-panel" style="padding:4px; ">
        <ul id="tt" class="easyui-tree">


<li><span>GROUP WARE</span>
							<ul>
								<c:forEach items="${deptList}" var="dept">
									<li data-options="state:'open'"><span>${dept.department_id}) ${dept.department_name}</span>
										<ul>
 											<c:forEach items="${memList}" var="mem">
												<c:if test="${dept.department_id eq mem.member_department}">
												<c:if test="${mem.rank_name == null}"> ${ mem.rank_name = "입사대기" }</c:if>
													<li>${mem.rank_name}|${mem.member_id}|${mem.member_name}</li> 
												</c:if>
											</c:forEach>
										</ul>
									</li>
								</c:forEach>
							</ul>
						</li>





        </ul>
    </div>
    </div>
    
    <div class="col-2 text-center">
    	<br><br><br><br><br><br><p style="color: red">>>></p>
    </div>
    
    <div class="container col-5" style="border: 1px solid gray; padding: 5px 10px 5px 20px; overflow-x:hidden; overflow-y:auto;">
    	
    	<div class="row">
    	<label>성명</label>
    	<input type="text" id="searchN"/>
    	<button id="searchNm" onclick="searchName()">검색</button>
    	</div>
    	
    	<div class="row">
    	
    	<table>
    	
    	<tr>
    	<th>부서</th>
    	<th>성명</th>
    	<th>직위</th>
    	<th>사번</th>
    	</tr>
    	
    	<tbody id="tbody">
      	<c:forEach var="item" items="${ memList }">
    	
    	<%-- <c:if test="${ item.department_name == null }">${ item.department_name = "발령대기" }</c:if> --%>
    	
	    	<tr onclick="pikAuthMem(${ item.member_id})" style="cursor: pointer;" class="hovBg">
	    	<td>
	    	<c:choose>
	    		<c:when test="${ item.department_name == null }">${ item.department_name = "발령대기" }</c:when>
	    		<c:otherwise>${ item.department_name }</c:otherwise>
	    	</c:choose>
	    	</td>
	    	<td>${ item.member_name }</td>
			<td>${ item.rank_name }</td>
			<td>${ item.member_id }</td>
    		</tr>
    	
    	</c:forEach>
    	</tbody>
    	</table>
    	
    	</div>
    
    </div>

    
    </div><!-- row  -->
    
    <table>
    
      	<tr>
      	<th>No.</th>
    	<th>부서</th>
    	<th>성명</th>
    	<th>직위</th>
    	<th>사번</th>
    	<th>순서</th>
    	<th>삭제</th>
    	</tr>
    	
    	<tbody id="finalList">
    	<c:forEach begin="1" end="3" varStatus="stat">
    	
    	<tr id="${ stat.count }" value="">
    	<td id="no_${ stat.count }">${ stat.count }</td>
    	<td id="dept_${ stat.count }"></td>
    	<td id="name_${ stat.count }"></td>
    	<td id="rank_${ stat.count }"></td>
    	<td id="memId_${ stat.count }"></td>
    	<td id="order_${ stat.count }"></td>
    	<td id="del_${ stat.count }"></td>
    	</tr>
    	
    	</c:forEach>
    	</tbody>
    
    </table>
    
    <span id="authMemList" num="1" style="display: inline-block; border: 1px solid black; width: 100px; height: 100px"></span>
    <span id="authMemList" num="2" style="display: inline-block; border: 1px solid black; width: 100px; height: 100px"></span>
    <span id="authMemList" num="3" style="display: inline-block; border: 1px solid black; width: 100px; height: 100px"></span>
    
    
    <script>
    
    $(document).ready(function(){
    	
    	var getMem = $(opener.document).find('#authMem').text();
    	$('#authMemList').text(getMem);
    	
    })
    
    $('#tt').tree({
    	onClick: function(node){
    		//alert(node.text);  // alert node text property when clicked
    		
    		//console.log(typeof(node.text))
    		if(node.text == 'GROUP WARE'){
    			$.ajax({
                    type: 'POST',
                    url: "${ pageContext.request.contextPath }/approval/getMemList",
                    data: param,
                    success: function(data) {
      					//console.log(data);

      					var obj = JSON.parse(data);
      					
      					$('#tbody').empty();
      					
      					printList(obj);

      					return;
				},
				error: function(){
					return;
				}
		});
    		}
    		
    		var arr = (node.text).split(')');
		    		
    		var param = "deptId="+arr[0];
    		 $.ajax({
                          type: 'POST',
                          url: "${ pageContext.request.contextPath }/approval/searchDept",
                          data: param,
                          success: function(data) {
            					//console.log(data);

            					try{
            					var obj = JSON.parse(data);
            					}catch(Exception){
            						//=================================================================================================================================최종처리
            						console.log(data)
            						
            						var arr = data.split('|');
            						console.log(arr[1])
            						
            						
            						return;
            					}
            					
            					
            					$('#tbody').empty();
            					
            					printList(obj);

            					return;
					},
					error: function(){
						return;
					}
			});
    		
    	}
    });
    
    
    $(function(){
    	  $('#searchN').keypress(function(e) {
    	    if(e.which == 13) {
    	      $(this).blur();
    	      $('#searchNm').focus().click();
    	      $('#searchN').focus();
    	    }
    	  });
    });
    
	 function searchName(){
		 var searchN = $('#searchN').val();
		 $('#searchN').val('');
		 
		 var param = "searchN="+searchN;
		 $.ajax({
             type: 'POST',
             url: "${ pageContext.request.contextPath }/approval/searchName",
             data: param,
             success: function(data) {
					//console.log(data);
					if(data == 'error'){
						return;
					}
					var obj = JSON.parse(data);
					
					$('#tbody').empty();
					
					printList(obj);

					return;
		},
		error: function(){
			return;
		}
}); //ajax end
		 
	 } //searchName() end
	 
	 function printList(obj){
			for(var i in obj){
				//console.log(obj[i])
			if(obj[i].department_name == null) obj[i].department_name = '발령대기'
				if(obj[i].rank_name == null) obj[i].rank_name = '입사대기'	
				$('<tr></tr>').css('cursor','pointer').attr('class','hovBg').attr('onclick','pikAuthMem('+obj[i].member_id+')').attr('id', obj[i].member_id).appendTo('#tbody');
				$('<td></td>').text(obj[i].department_name).appendTo('#'+obj[i].member_id+'');
				$('<td></td>').text(obj[i].member_name).appendTo('#'+obj[i].member_id+'');
				$('<td></td>').text(obj[i].rank_name).appendTo('#'+obj[i].member_id+'');
				$('<td></td>').text(obj[i].member_id).appendTo('#'+obj[i].member_id+'');
			}
	 }
	 
	 var MIN_NUM = 1;
	 var MAX_NUM;

	 function pikAuthMem(member_id){
		 //=====================================================================================================================================================최종 처리
		console.log(member_id);
		 
		$('#authMemList')
		 
		var trArr = $('#finalList > tr');
		MAX_NUM = trArr.length;
		 
		for(var j = MIN_NUM; j <= MAX_NUM ; j++){
			
			if($('#memId_'+j+'').text() == member_id){
				alert('이미 추가되어 있는 결재자 입니다.')
				return;
			} 
			
		}
		
		 for(var i = 0 ; i < trArr.length ; i++){
			 
			 //console.log(trArr.length)
			 console.log(trArr[i].value);

			 
			 
			 if(trArr[i].value == null || trArr[i].value == ''){
				 
				 $('#memId_'+(i+1)+'').text(member_id);
				 $('#del_'+(i+1)+'').html('<a class="xBtn" onclick="delLine('+(i+1)+')">[ X ]</a>');
				 $('#order_'+(i+1)+'').html('&nbsp;<a class="upBtn" onclick="upBtn('+(i+1)+')">▲</a>&nbsp;<a class="dnBtn" onclick="dnBtn('+(i+1)+')">▼</a>&nbsp;')
				 trArr[i].value = 'exist';
				 return;
			 }
			 
		 }
		 
		 
		 $(opener.document).find('#authMem').text(member_id);
		 
	 } // pikAuthMem() end
	 
	 
	 function delLine(i){
		 
		 if($('#'+(i+1)+'').val() == 'exist'){
			 alert('차순 결재자가 있습니다.');
			 return;
		 }else{
			$('#'+i+'').val('');
			$('#dept_'+i+'').text('');
			$('#name_'+i+'').text('');
			$('#rank_'+i+'').text('');
			$('#memId_'+i+'').text('');
			
			$('#del_'+i+'').html('');
			$('#order_'+i+'').html('');
		 }
		 
	 } // delLine() end
	 
	 function upBtn(i){
		 
		if(i == MIN_NUM){
			return;
		}
		 
		var dept = $('#dept_'+(i-1)+'').text();
		var name = $('#name_'+(i-1)+'').text();
		var rank = $('#rank_'+(i-1)+'').text();
		var memId = $('#memId_'+(i-1)+'').text();
		
		$('#dept_'+(i-1)+'').text($('#dept_'+i+'').text());
		$('#name_'+(i-1)+'').text($('#name_'+i+'').text());
		$('#rank_'+(i-1)+'').text($('#rank_'+i+'').text());
		$('#memId_'+(i-1)+'').text($('#memId_'+i+'').text());
		
		$('#dept_'+i+'').text(dept);
		$('#name_'+i+'').text(name);
		$('#rank_'+i+'').text(rank);
		$('#memId_'+i+'').text(memId);
		 
	 }
	 
	 function dnBtn(i){

			if(i == MAX_NUM){
				return;
			}
			 
			var dept = $('#dept_'+(i+1)+'').text();
			var name = $('#name_'+(i+1)+'').text();
			var rank = $('#rank_'+(i+1)+'').text();
			var memId = $('#memId_'+(i+1)+'').text();
			
			$('#dept_'+(i+1)+'').text($('#dept_'+i+'').text());
			$('#name_'+(i+1)+'').text($('#name_'+i+'').text());
			$('#rank_'+(i+1)+'').text($('#rank_'+i+'').text());
			$('#memId_'+(i+1)+'').text($('#memId_'+i+'').text());
			
			$('#dept_'+i+'').text(dept);
			$('#name_'+i+'').text(name);
			$('#rank_'+i+'').text(rank);
			$('#memId_'+i+'').text(memId);

	 }
    
    </script>
    
    <style>
    
    .hovBg:hover {
    
    background-color: lightgray;
    
    }
    
    .xBtn:hover, .upBtn:hover, .dnBtn:hover {

    cursor: pointer;
    color: green;
    font-weight: bold;
    
    }
    
    </style>


</body>
</html>